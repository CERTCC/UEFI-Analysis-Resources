# CVE-2021-28216: Arbitrary Write in EDK2

## Proof of Concept w/QEMU+OVMF

### Prerequisites
This vulnerability is easiest to trigger when booting a minimal Linux ISO which can be suspended. This is primarily due to the performance impact of the UEFI debugging environment.

We found success using [Minimal Linux Live](https://github.com/ivandavidov/minimal) and [adding a "bundle" for pm-utils](https://github.com/trentn/minimal/tree/wip/src/minimal_overlay/bundles/pm-utils).

### Building the vulnerable firmware

The default builds for an OVMF firmware from EDK2 source does not include the vulnerability.

The steps are as follows (note that following these steps will build a debug version):


1. Clone the EDK2 source and [set up the build environment](./EDK2_Dev_Overview.md)

2. Copy the `FirmwarePerformanceVulReproPkg` to the EDK source directory

3. Run the build command from the `edk2` directory  
```bash
build -a IA32 -a X64 -b DEBUG -p FirmwarePerformanceVulReproPkg/FirmwarePerformance.dsc -D SOURCE_DEBUG_ENABLE -t GCC5
```

The output will be in - `edk2/Build/FirmwarePerformanceVulRepro/DEBUG_GCC5`

The two important files are:  
`edk2/Build/FirmwarePerformance/DEBUG_GCC5/FV/OVMF_CODE.fd`  
`edk2/Build/FirmwarePerformance/DEBUG_GCC5/FV/OVMF_VARS.fd`

### Running the Vulnerable Firmware

Using the two files listed above the following command can be used to boot the vulnerable firmware:

```bash
qemu-system-x86_64 \
	-net none \
	-debugcon file:debug.log -global isa-debugcon.iobase=0x402 \
	-monitor stdio \
	-machine q35,smm=on,accel=kvm \
  	-m 2G \
  	-smp 2 \
  	-global driver=cfi.pflash01,property=secure,value=on \
  	-drive if=pflash,format=raw,unit=0,file=OVMF_CODE.fd,readonly=on \
  	-drive if=pflash,format=raw,unit=1,file=OVMF_VARS.fd \
	-cdrom linux.iso
```

### Triggering the Vulnerable Code

Triggering the vulnerable code is fairly straight forward:

- Boot an OS (the linux.iso in the command above) using a vulnerable firmware
- Enter S3 Suspend (`pm-suspend`)
- Resume the machine (VM in this case)

The vulnerable code will be executed during the PEI phase of S3 Resume.

### Controlling the Vulnerability

The default EDK2 source code does not make the vulnerable NVRAM variable easily accessible from the OS level (EFIVARS sysfs in Linux).  
This is because the variable is [created with only `EFI_VARIABLE_NON_VOLATILE | EFI_VARIABLE_BOOTSERVICE_ACCESS`](https://github.com/tianocore/edk2/blob/stable/202011/MdeModulePkg/Universal/Acpi/FirmwarePerformanceDataTableDxe/FirmwarePerformanceDxe.c#L367) permissions.  
This means it persists between boots, but is not supposed to be accessible once entering the OS runtime environment: https://edk2-docs.gitbook.io/edk-ii-uefi-driver-writer-s-guide/5_uefi_services/readme.2/525_getvariable_and_setvariable  
To make the variable trivially accessible the `EFI_VARIABLE_RUNTIME_ACCESS` flag can be added to that source code line. Obviously this is for proof of concept and ease of analysis purposes only.

Another means of directly modifying NVRAM is necessary to realistically exploit this vulnerability from the OS level.
